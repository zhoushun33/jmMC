<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>江门市气象局在线监测系统</title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link rel="stylesheet" href="../css/mui.min.css">	
		<link rel="stylesheet" href="../css/my_css.css">
		<link rel="stylesheet" href="../css/my_project_fhys_xz.css" />
		<link rel="stylesheet" href="../css/mui.picker.min.css"/>
		<link rel="stylesheet" href="../css/mui.poppicker.css"/>
		<style>
			#reinspection{
				min-width: 300px;
				height:150px;				
				top:35%;
				/*position:relative;*/
				left:9%;
			}
			#consigncode{
				min-width: 300px;
				height:150px;				
				top:35%;
				/*position:relative;*/
				left:9%;
			}
			#consigncode2{
				min-width: 300px;
				height:150px;				
				top:35%;
				/*position:relative;*/
				left:9%;
			}
			#zuyPopover{
				min-width: 300px;
				height:150px;				
				top:35%;
				/*position:relative;*/
				left:9%;

			}
			#recPopover{
				min-width: 300px;
				height:150px;				
				top:35%;
				/*position:relative;*/
				left:8%;
			}
			#btnPopover{
				min-width: 300px;
				height:100px;				
				top:40%;
				/*position:relative;*/
				left:8%;

			}
			#addNew{
				position:fixed;
				right:10px;
				bottom:50px;
				/*background-color:transparent;*/
		        z-index: 998 ;
		    }
		   
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
		    <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
		    <h1 id="refresh" class="mui-title">在线检测</h1>
		</header>
		<div>
			<button id="addNew" class="mui-btn mui-fab mui-btn-mini mui-btn-danger">
            	<span class="mui-icon mui-icon-plusempty"></span>
       		</button>
		</div>
		<div id="refreshContainer" class="mui-content">
		    <div style="padding: 10px 10px;">
				<div id="segmentedControl" class="mui-segmented-control">
					<div class="mui-slider">
		       			<div id="xuanxiangka" class="mui-slider-group mui-slider-loop ">
		        		   	<div class="mui-slider-item">
		         		       <a id="" class="mui-control-item  mui-active"  href="#item1">
									委托检测(检测单位)
								</a>
								<a id="" class="mui-control-item"  href="#item2">
									监理见证(监理单位)
								</a>
								<a id="" class="mui-control-item"  href="#item3">
									检测结果(检测单位)
								</a>
		         		   </div>
		      		  	</div>
		   			</div>
				</div> 
			</div>
			
			<!--委托编号-->
			<div id="consigncode" class="mui-popover">
	    		<h4 id="title" style="text-align: center;margin-top: 15px;">确定见证</h4>
	    		<form class="mui-input-group" style="margin-top: 15px;" id="concode">
	    			<div class="mui-input-row">
	    				<label>委托编号:</label>
	    				<input id="code_input" type="text" class="mui-input-clear" placeholder="输入委托编号">
	    			</div>    			
	    		</form>
				<div id="code_act"  class="mui-button-row my_margintop10px">
					<button id="code_close"  type="button" class="mui-btn mui-btn-primary mui-action-back" >取消</button>					
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
					<button id="code_sure" type="button" class="mui-btn mui-btn-primary" onclick="inpcode(this)">确认</button>
				</div>
			</div>
			<!--委托编号-->
			<!--验证码-->
			<div id="zuyPopover" class="mui-popover">
        		<h4 id="title" style="text-align: center;margin-top: 15px;">确定见证</h4>
        		<form class="mui-input-group" style="margin-top: 15px;">
        			<div class="mui-input-row">
        				<label>验证码:</label>
        				<input id="code" type="number" class="mui-input-clear" placeholder="输入验证码" value="">
        			</div>    			
        		</form>
				<div id="comfirm"  class="mui-button-row my_margintop10px">
					<button   type="button" class="mui-btn mui-btn-primary" onclick="qdjz(this)">确定</button>					
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
					<button id="sendMsg" type="button" class="mui-btn mui-btn-primary" onclick="time(this)">获取验证码</button>
				</div>
			</div>
			<form class="mui-input-group my_none">
			    <div class="mui-input-row my_none">
			        <label>企业ID</label>
			        <input name="CorpID"  type="text" id="CorpID" class="mui-input-clear" value="101781">
			    </div>
			    <div class="mui-input-row my_none">
			        <label>登录名</label>
			        <input name="LoginName" type="text" id="LoginName" class="mui-input-clear" value="Admin">
			    </div>
			    <div class="mui-input-row  my_none">
			        <label>密码</label>
			        <input name="pwd" type="text" id="pwd" class="mui-input-clear" value="174012" >
			    </div>
			    <div class="mui-input-row  my_none">
			        <label>服务器地址</label>
			        <input name="serverIP" type="text" id="serverIP" class="mui-input-clear"  value="http://sms.mobset.com:8080/Api?wsdl">
			    </div>
			    <div class="mui-input-row  my_none">
			        <label>手机号码</label>
			        <input name="mobPhone" type="text" id="mobPhone" class="mui-input-clear"  >
			    </div>
			    <div class="mui-input-row  my_none">
			        <label>短信内容</label>
			        <input name="smsContent" type="text" id="smsContent" class="mui-input-clear" value="验证码：">
			    </div>
			     <div class="mui-input-row  my_none">
			        <label>验证码</label>
			        <input name="yzm" type="text" id="yzm" class="mui-input-clear" >
			    </div>
			</form>
			<!---------------------------------委托检测------------------------------------------->
			<div id="item1" class="mui-control-content  mui-active">
			    <div  class="mui-scroll-wrapper">
			    	<div id="draft" class="mui-scroll rwdiv">

					</div>
			    </div>
			</div>
			<!---------------------------------委托检测------------------------------------------->
			
			<!---------------------------------监理见证------------------------------------------->
			<div id="item2" class="mui-control-content">
				<div id="scroll" class="mui-scroll-wrapper">
			    	<div id="witness" class="mui-scroll rwdiv">
	
					</div>
			    </div>
			</div>
			<!---------------------------------监理见证------------------------------------------->
			
			<!--------------------------------------结果----------------------------->
			<div id="item3" class="mui-control-content">
				<div id="scroll" class="mui-scroll-wrapper">
			    	<div id="result" class="mui-scroll rwdiv">
	    				
					</div>
			    </div>
			</div>
			<div id="consigncode2" class="mui-popover">
	    		<h4 id="title" style="text-align: center;margin-top: 15px;">合格</h4>
	    		<form class="mui-input-group" style="margin-top: 15px;" id="concode1">
	    			<div class="mui-input-row">
	    				<label>检测报告编号:</label>
	    				<input id="testNum" class="mui-input-clear" placeholder="输入检测报告编号">
	    			</div>    			
	    		</form>
				<div id="code_act1"  class="mui-button-row my_margintop10px">
					<button id="code_close"  type="button" class="mui-btn mui-btn-primary mui-action-back" >取消</button>					
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
					<button id="code_sure" type="button" class="mui-btn mui-btn-primary" onclick="inpcode1(this)">确认</button>
				</div>
			</div>
			<!--------------------------------------结果----------------------------->
			
		<!--验证码-->
		</div>
		
		<script src="../js/mui.min.js"></script>
		<script src="../js/mui.picker.js"></script>
		<script src="../js/mui.poppicker.js"></script>
		<script src="../js/native.js"></script>
		<script src="../js/service.js"></script>
		<script type="text/javascript">
			
			
			//区域滚动,需手动初始化scroll控件
			mui('.mui-scroll-wrapper').scroll({
				deceleration: 0.0005 //flick 减速系数，系数越大，滚动速度越慢，滚动距离越小，默认值0.0006
			});
			mui.plusReady(function(){
				mui.init({
					gestureConfig:{					
						longtap: true, //长按默认为false
						doubletap: true
					},
					pullRefresh : {
						container : '#refreshContainer', //一个功能的一部分
//						up : {
//						      height:50,//可选.默认50.触发上拉加载拖动距离
//						      auto:true,//可选,默认false.自动上拉加载一次
//						      contentrefresh : "正在加载...",//可选，正在加载状态时，上拉加载控件上显示的标题内容
//						      contentnomore:'没有更多数据了',//可选，请求完毕若没有更多数据时显示的提醒内容；
//						      callback :pullfresh
//						    }
					}
				});
				function pullfresh() {
				     //业务逻辑代码，比如通过ajax从服务器获取新数据；
				     //注意，加载完新数据后，必须执行如下代码，注意：若为ajax请求，则需将如下代码放置在处理完ajax响应数据之后
//				     mui('#refreshContainer').pullRefresh().endPulldownToRefresh();
				     this.endPullupToRefresh(true|false); 
				}
				var doc = document;
				//获取传值
				var self = plus.webview.currentWebview();
				//全局变量mobile
				pj_id = self.pj_id;//工程id
				mobile = self.mobile;//手机号码
				my_name = self.my_name;//用户姓名
	            gcmc = self.gcmc; //工程名称
	            constr = self.constr; //施工单位
	            supvision = self.supvision; //监理单位
	            detect = self.detect; //检测单位
	            timestamp = self.timestamp;//工程时间戳
	            jclx = self.jclx;//检测类型
				gcmc_c = encodeURI(encodeURI(gcmc)); //获取工程名称
				my_name = decodeURI(decodeURI(my_name)); //获取用户名
				var doc = document;
				var my_popover = doc.getElementById("my_popover");
				var draft = doc.getElementById("draft");
				var witness = doc.getElementById("witness");
				var result = doc.getElementById("result");
				var addnew = doc.getElementById('addNew');
				var refresh = doc.getElementById("refresh");
				var myDate = new Date();//获取系统当前时间
				mytime=myDate.toLocaleString();//获取日期与时间
				var refresh = doc.getElementById("refresh");
				//监听标题栏的双击事件(刷新页面)
				refresh.addEventListener('doubletap',function () {
					window.location.reload();
				});
				//获取当前时间
				var date = new Date();
				var year = date.getFullYear(); //获取当前年份
				var mon = date.getMonth() + 1; //获取当前月份    
				var da = date.getDate(); //获取当前日    
				var day = date.getDay(); //获取当前星期几    
				var h = date.getHours(); //获取小时    
				var m = date.getMinutes(); //获取分钟  
				if(da<10){
					var time01 = year + "-%" + mon + "-0" + da;
				} else {
					var time01 = year + "-%" + mon + "-" + da;
				}
				//检验这个手机号码今天是否签过到
				var qd="未签到";
				mui.ajax(url + 'my_plus/attention_ewm.php', {
						data: {
							flag: 'select',
							gcid: pj_id, //工程id
							mobile:mobile, //手机
							qdTime: time01
						},
						dataType: 'json',
						type: 'post',
						timeout: 10000,
						success: function(data) {
							if(data.result == 'OK') {
								qd = "已签到";
							} else {
								qd = "未签到";
							}
						},
						error: function(xhr, type, errorThrown) {
//							return callback('ajax错误' + type + errorThrown);
						}
					});
				//悬浮新增监听
				addNew.addEventListener('tap',function(){
					mui.ajax(url+'check.php',{
						data:{
							ulId:"",
							mobile:mobile,
							flag:"online"
						},
						dataType:'json',
						type:'post',
						timeout:10000,
						success:function(data){
//							alert(data)
							if(data['单位类型']=='检测单位'||data['单位类型']=='管理'){
								if(qd=="已签到"){
									mui.openWindow({
										id:'material_add.html',
										url:"material_add.html",
										extras:{
											//传递参数
											gcmc_c:gcmc_c,
											my_name:my_name,
											timestamp:timestamp,
											detect:detect,
											jclx:jclx,
											supvision:supvision
										},
										show: {
											aniShow:"pop-in"
										},
										waiting: {
											autoShow: false
										}
									});
								}else{
									alert("签到后才能进行操作");
								}
								
							}else{
								alert("抱歉，您没有新建卡项的权限");
							}
						},
						error:function(xhr,type,errorThrown){
							alert('ajax错误'+type+'---'+errorThrown+"失败！");
						}
					});	
					
				});
				
				
				//动态创建函数
				function mymaterial(gcdzt,id,gclx,jcdw,jclx,jcr,jcrq,sjc,count){
					
					if(gcdzt=="新增"){
						var draft = document.getElementById("draft");
						var ul = document.createElement("ul");
						ul.className = "mui-table-view mui-card my_list my_marginbottom10px";
						ul.id = id;
						ul.innerHTML = '<li class="mui-table-view-cell my_backgroundcolor_blue2"><a class="a_color" href="online_readmessage.html?sjc='+sjc+'&ulid='+id+'&gcmc='+gcmc_c+'&jcdl='+jclx+'"><span class="mui-icon mui-icon-gear mui-pull-left my_fontweight my_color_white"></span><p class="mui-ellipsis my_style2">'+gclx+'</p></a></li><li class="mui-table-view-cell"><p class="mui-ellipsis my_style1">检测类型：'+jclx+'</p></li><li class="mui-table-view-cell"><p class="mui-ellipsis my_style1">检测项目：'+count+'项</p></li><li class="mui-table-view-cell"><p class="mui-ellipsis my_style1">检测人：'+jcr+'</p></li><li class="mui-table-view-cell"><p class="mui-ellipsis my_style1">检测日期：'+jcrq+'</p></li>';
						draft.appendChild(ul);
					}else if(gcdzt=="准备"){
						var draft = document.getElementById("draft");
						var ul = document.createElement("ul");
						ul.className = "mui-table-view mui-card my_list my_marginbottom10px";
						ul.id = id;
						ul.innerHTML = '<li class="mui-table-view-cell my_backgroundcolor_green2"><a class="a_color" href="detection_samDet.html?sjc='+sjc+'&ulid='+id+'&type=zb"><span class="mui-icon mui-icon-gear mui-pull-left my_fontweight my_color_white"></span><p class="mui-ellipsis my_style2">'+ gclx +'</p></a></li><li class="mui-table-view-cell"><p class="mui-ellipsis my_style1">检测类型：'+jclx+'</p></li><li class="mui-table-view-cell"><p class="mui-ellipsis my_style1">检测项目：'+count+'项</p></li><li class="mui-table-view-cell"><p class="mui-ellipsis my_style1">检测人：'+ jcr +'</p></li><li class="mui-table-view-cell"><p class="mui-ellipsis my_style1">检测日期：'+ jcrq +'</p></li>';
						draft.appendChild(ul);
					}
					else if(gcdzt=="未见证"){
						var witness = document.getElementById("witness");
						var ul = document.createElement("ul");
						ul.className = "mui-table-view mui-card my_list my_marginbottom10px";
						ul.id = id;
						ul.innerHTML = '<li class="mui-table-view-cell my_backgroundcolor_blue2"><a class="a_color" href="detection_samDet.html?sjc='+sjc+'&ulid='+id+'&type=zb"><span class="mui-icon mui-icon-gear mui-pull-left my_fontweight my_color_white"></span><p class="mui-ellipsis my_style2">'+ gclx +'</p></a></li><li class="mui-table-view-cell"><p class="mui-ellipsis my_style1">检测类型：'+jclx+'</p></li><li class="mui-table-view-cell"><p class="mui-ellipsis my_style1">检测项目：'+count+'项</p></li><li class="mui-table-view-cell"><p class="mui-ellipsis my_style1">检测人：'+ jcr +'</p></li><li class="mui-table-view-cell"><p class="mui-ellipsis my_style1">检测日期：'+ jcrq +'</p></li>';
						witness.appendChild(ul);						
					}
					else if(gcdzt=="已见证"){
						var witness = document.getElementById("witness");
						var ul = document.createElement("ul");
						ul.className = "mui-table-view mui-card my_list my_marginbottom10px";
						ul.id = id;
						ul.innerHTML = '<li class="mui-table-view-cell my_backgroundcolor_green2"><a class="a_color" href="detection_samDet.html?sjc='+sjc+'&ulid='+id+'&type=jz"><span class="mui-icon mui-icon-gear mui-pull-left my_fontweight my_color_white"></span><p class="mui-ellipsis my_style2">'+ gclx +'</p></a></li><li class="mui-table-view-cell"><p class="mui-ellipsis my_style1">检测类型：'+jclx+'</p></li><li class="mui-table-view-cell"><p class="mui-ellipsis my_style1">检测项目：'+count+'项</p></li><li class="mui-table-view-cell"><p class="mui-ellipsis my_style1">检测人：'+ jcr +'</p></li><li class="mui-table-view-cell"><p class="mui-ellipsis my_style1">检测日期：'+ jcrq +'</p></li>';
						witness.appendChild(ul);						
					}
					else if(gcdzt=="结果"){
						var result = document.getElementById("result");
						var ul = document.createElement("ul");
						ul.className = "mui-table-view mui-card my_list my_marginbottom10px";
						ul.id = id;
						ul.innerHTML = '<li class="mui-table-view-cell my_backgroundcolor_green2"><a class="a_color" href="detection_samDet.html?sjc='+sjc+'&ulid='+id+'&type=jz"><span class="mui-icon mui-icon-gear mui-pull-left my_fontweight my_color_white"></span><p class="mui-ellipsis my_style2">'+ gclx +'</p></a></li><li class="mui-table-view-cell"><p class="mui-ellipsis my_style1">检测类型：'+jclx+'</p></li><li class="mui-table-view-cell"><p class="mui-ellipsis my_style1">检测项目：'+count+'项</p></li><li class="mui-table-view-cell"><p class="mui-ellipsis my_style1">检测人：'+ jcr +'</p></li><li class="mui-table-view-cell"><p class="mui-ellipsis my_style1">检测日期：'+ jcrq +'</p></li>';
						result.appendChild(ul);						
					}
				}
				//异步取值并创建卡项
				mui.ajax(url+'detection/online_list.php',{
					data:{
						flag:"创建卡项",
						gcmc:gcmc,
						jclx:jclx,
						timestamp:timestamp
					},
					dataType:'json',
					type:'POST', 
					timeout:10000,
					success:function(data){
//						alert(data);
						var length=data.length;
//						alert(length+","+data[0].idd);
						if (length>=1) {
							for (var i=0;i<=length-1;i++){
								var id = data[i].卡项id;
								var gcdzt = data[i].工程单状态;
								var gclx = data[i].工程类型;
								var jclx = data[i].检测类型;
								var jcdw = data[i].检测单位;
								var jcr = data[i].检测人;
								var jcrq = data[i].检测时间;
								var sjc = data[i].时间戳;
								var count = data[i].检测项目个数;
								mymaterial(gcdzt,id,gclx,jcdw,jclx,jcr,jcrq,sjc,count);
							}
						}else{
							alert("暂无数据");
						}
					},
					error:function(xhr,type,errorThrown){
						alert('ajax错误'+type+'---'+errorThrown+"失败！");
					}
				});
				
				//获取对应手机短信验证码
				mui.ajax(url+'send_Sms/AddSms.php',{
					data:{
						flag:'read',
						mobile:mobile,
						gcmc:gcmc,
						submodule:'实体检测'
					},
					dataType:'json',  
					type:'post',
					timeout:10000,
					success:function(data){
						var dataLength = data.length;
						var SecurityCode = data[dataLength-1].验证码;
						var yzm = doc.getElementById("yzm");
						if(SecurityCode){
							yzm.value = SecurityCode;
						}
					},
					error:function(xhr,type,errorThrown){
//						alert('ajax错误'+type+'---'+errorThrown+"失败！");
					}
				});
				////////////////////////////委托检测//////////////////////////////
				mui('#draft').on('longtap','ul',function(){
					var ulId = this.id;//获取当前的卡项的id
					 mui.ajax(url+'check.php',{
						data:{
							ulId:ulId,
							mobile:mobile,
							flag:"online"
						},
						dataType:'json',
						type:'post',
						timeout:10000,
						success:function(data){
							if(data['单位类型']=='检测单位'||data['单位类型']=='管理'){
								if(qd=="已签到"){
									mui.ajax(url+'detection/online_list.php',{
										data:{
											flag:"获取状态",
											ulid:ulId,
											gcmc:gcmc,
											timestamp:timestamp
										},
										dataType:'json',
										type:'POST', 
										timeout:10000,
										success:function(data){
											var gcdzt_pd = data.工程单状态;
				
											//判断状态并根据状态执行改变状态的任务
											if(gcdzt_pd=='新增'){
												var btnArray = [
												{title:"提交检测"},
												{title:"删除"}
												]; 
												plus.nativeUI.actionSheet({
													title:"操作", 
													cancel:"取消",
													buttons:btnArray
												},function(e){
													var index = e.index;	
													//var nextpage='';
													switch (index){
														case 1://准备
															//输入委托编号
															mui("#consigncode").popover("toggle");
															var but_id=document.getElementById("code_act").getElementsByTagName('button')[1];
															but_id.id=ulId;
															break;
														case 2://删除
															mui.ajax(url+'detection/online_list.php',{
																data:{
																	flag:"删除",
																	ulid:ulId,
																	gcmc:gcmc,
																	timestamp:timestamp
																},
																dataType:'json',
																type:'POST', 
																timeout:10000,
																success:function(data){
				//													alert(data.结果);
																	mui.toast(data.结果,{ duration:'long', type:'div' })
																	location.reload();//刷新本页面
																},
																error:function(xhr,type,errorThrown){
						//											alert('ajax错误'+type+'---'+errorThrown+"失败！");
																}
															});
															break;
													}	
												 });
											}else if(gcdzt_pd=='准备'){
												var btnArray = [
												{title:"提交见证"},
												{title:"撤销准备"}
												];
												plus.nativeUI.actionSheet({
													title:"操作",
													cancel:"取消",
													buttons:btnArray
												},function(e){
													var index = e.index;	
													//var nextpage='';
													switch (index){
														case 1://提交见证
															mui.ajax(url+'detection/online_list.php',{
																data:{
																	flag:'提交见证',
																	ulid:ulId,
																	gcmc:gcmc
																},
																dataType:'json',
																type:'POST', 
																timeout:10000,
																success:function(data){
	//																alert(data)
																	if(data.结果=='success'){
										   								mui.toast('操作成功',{ duration:'long', type:'div' }) 
																		location.reload();
																	}
																},
																error:function(xhr,type,errorThrown){
																	alert('ajax错误'+type+'---'+errorThrown);
																}
															});
															break;
														case 2://撤销准备
															mui.ajax(url+'detection/online_list.php',{
																data:{
																	flag:"撤销准备",
																	ulid:ulId,
																	gcmc:gcmc,
																	timestamp:timestamp
																},
																dataType:'json',
																type:'POST', 
																timeout:10000,
																success:function(data){
																	mui.toast(data.结果,{ duration:'long', type:'div' })
																	location.reload();//刷新本页面
																},
																error:function(xhr,type,errorThrown){
						//											alert('ajax错误'+type+'---'+errorThrown+"失败！");
																}
															});
															break;
													}	
												  }
												);
											}
										},
										error:function(xhr,type,errorThrown){
	//										alert('ajax错误'+type+'---'+errorThrown+"失败！");
										}
									});
								}else{
									alert("签到后才能进行操作");
								}
								
							}else{
								var btnArray = [
									{title:"抱歉，您没有操作权限"}
								]; 
								plus.nativeUI.actionSheet({
									title:"操作", 
									cancel:"取消",
									buttons:btnArray
								},function(e){
								});
							}
						},
						error:function(xhr,type,errorThrown){
							alert('ajax错误'+type+'---'+errorThrown+"失败！");
						}
					});
				});
				////////////////////////////委托检测//////////////////////////////
				////////////////////////////监理见证//////////////////////////////
				mui("#witness").on('longtap','ul',function(){
					var ulId = this.id;
					  mui.ajax(url+'check.php',{
						data:{
							ulId:ulId,
							mobile:mobile,
							flag:"online"
						},
						dataType:'json',
						type:'post',
						timeout:10000,
						success:function(data){
							if((data['单位类型']=='监理单位')||data['单位类型']=='管理'){
								if(qd=="已签到"){
									mui.ajax(url+'detection/online_list.php',{
										data:{
											flag:"获取状态",
											ulid:ulId,
											gcmc:gcmc,
											timestamp:timestamp
										},
										dataType:'json',
										type:'POST', 
										timeout:10000,
										success:function(data){
											var gcdzt_pd = data.工程单状态;
											if(gcdzt_pd=='未见证'){
												var btnArray = [
												{title:"确认见证"}
												];
												plus.nativeUI.actionSheet({
													title:"操作",
													cancel:"取消",
													buttons:btnArray
												},function(e){
													var index = e.index;	
													//var nextpage='';
													switch (index){
														case 1://确认见证
				//											//执行验证码
															mui("#zuyPopover").popover("toggle");
															var but_id=document.getElementById("comfirm").getElementsByTagName('button')[0];
															but_id.id=ulId;
				//											alert('wait a moment');
															break;
													}
												  }
												);
											}else if(gcdzt_pd=='已见证'){
												var btnArray = [
												{title:"提交结果"},
												];
												plus.nativeUI.actionSheet({
													title:"操作",
													cancel:"取消",
													buttons:btnArray
												},function(e){
													var index = e.index;	
													switch (index){
														case 1://提交结果
															mui.ajax(url+'detection/online_list.php',{
																data:{
																	flag:"提交结果",
																	ulid:ulId,
																	gcmc:gcmc,
																	timestamp:timestamp
																},
																dataType:'json',
																type:'POST', 
																timeout:10000,
																success:function(data){
				//													alert("ajax success!");
				//													alert(data.结果);
																	mui.toast(data.结果,{ duration:'long', type:'div' })
																	location.reload();//刷新本页面
																},
																error:function(xhr,type,errorThrown){
						//											alert('ajax错误'+type+'---'+errorThrown+"失败！");
																}
															});
															break;
														case 2://
															break;
													}	
												  }
												);
											}
										},
										error:function(xhr,type,errorThrown){
	//										alert('ajax错误'+type+'---'+errorThrown+"失败！");
										}
									});	
								}else{
									alert("签到后才能进行操作");
								}
								
							}else{
								var btnArray = [
									{title:"抱歉，您没有操作权限"}
								]; 
								plus.nativeUI.actionSheet({
									title:"操作", 
									cancel:"取消",
									buttons:btnArray
								},function(e){
								});
							}
						},
						error:function(xhr,type,errorThrown){
//							alert('ajax错误'+type+'---'+errorThrown+"失败！");
						}
					});
					
				});
				////////////////////////////监理见证//////////////////////////////
				
				 ////////////////////////////结果//////////////////////////////
				mui("#result").on('longtap','ul',function(){
					var ulId = this.id;
					mui.ajax(url+'check.php',{
						data:{
							ulId:ulId,
							mobile:mobile,
							flag:"online"
						},
						dataType:'json',
						type:'post',
						timeout:10000,
						success:function(data){
							if((data['单位类型']== '检测单位')||data['单位类型']=='管理'){
								if(qd=="已签到"){
									mui.ajax(url+'detection/online_list.php',{
										data:{
											flag:"获取状态",
											ulid:ulId,
											gcmc:gcmc,
											timestamp:timestamp
										},
										dataType:'json',
										type:'POST', 
										timeout:10000,
										success:function(data){
											var gcdzt_pd = data.工程单状态;
											if(gcdzt_pd=='结果'){
												var btnArray = [
												{title:"合格"},
												{title:"不合格"}
												];
												plus.nativeUI.actionSheet({
													title:"操作",
													cancel:"取消",
													buttons:btnArray
												},function(e){
													var index = e.index;	
													switch (index){
														case 1://合格
															var btnArray = ['是', '否'];
																mui.confirm('确定将该送检鉴定为合格？', '江门市气象局在线监测系统', btnArray, function(e) {
																	if (e.index == 0) {
																		//输入检测报告编号
																		mui("#consigncode2").popover("toggle");
																		var but_id=document.getElementById("code_act1").getElementsByTagName('button')[1];
																		but_id.id=ulId;
																	}	
																});
															break;
														case 2://不合格
															//不合格推送通知
	//														var server=url+"push/push.php";
	//														var task=plus.uploader.createUpload(server,{method:"POST"},	function(t,status){ 
	//															//推送完成
	//															if(status==200){
	//																alert("不合格出现!将通知各单位");
	//															}else{
	//																alert("失败");
	//															}
	//														});
	//														task.addData("title",'江门市建设工程施工质量管理系统');
	//														task.addData("notice",gcmc+'——（实体检测）出现新的不合格项目！');
	//														task.addData("pj_id",pj_id);
	//														task.start();
															mui.openWindow({
																url:'online_fail.html',
																styles: {
																	hardwareAccelerated:false
																},
																extras:{
																	//传递参数
																	ulId:ulId
																},
																show:{
																	autoShow:true,//页面loaded事件发生后自动显示
																	aniShow:'slide-in-right',//页面显示动画
																	duration:'100'//页面动画持续时间
																},
																waiting:{
																	autoShow:false,//自动显示等待框
																}
															});
															break;
													}	
												  }
												);
											}
											
										},
										error:function(xhr,type,errorThrown){
	//										alert('ajax错误'+type+'---'+errorThrown+"失败！");
										}
									});
								}else{
									alert("签到后才能进行操作");
								}
								
							}else{
								var btnArray = [
									{title:"抱歉，您没有操作权限"}
								]; 
								plus.nativeUI.actionSheet({
									title:"操作", 
									cancel:"取消",
									buttons:btnArray
								},function(e){
								});
							}
						},
						error:function(xhr,type,errorThrown){
//							alert('ajax错误'+type+'---'+errorThrown+"失败！");
						}
					});	
				});
				////////////////////////////结果//////////////////////////////
			});
			
			//验证码监听
			var wait = 60;
			function time(o){
				myName = decodeURI(decodeURI(my_name));
//				alert(qylx);
				 if (wait == 0) {  
		            o.removeAttribute("disabled");            
		            o.innerHTML="获取验证码";  
		            wait = 60;  
		        }else{
		        	if(wait == 60){
		        		//短信发送
						var sendMsg = document.getElementById("sendMsg");
						var CorpID = document.getElementById("CorpID");
						var LoginName = document.getElementById("LoginName");
						var pwd = document.getElementById("pwd");
						var serverIP = document.getElementById("serverIP");
						var mobPhone = document.getElementById("mobPhone");
						var smsContent = document.getElementById("smsContent");
						mobPhone.value = mobile;
						yzm = document.getElementById("yzm");
						mui.ajax(url+'sms/SendSms.php',{
							data:{
								CorpID:CorpID.value,
								LoginName:LoginName.value,
								pwd:pwd.value,
								serverIP:serverIP.value,
								mobPhone:mobPhone.value,
								smsContent:smsContent.value
							},
							dataType:'json', 
							type:'POST', 
							timeout:10000,
							success:function(data){
//								alert(data);
								if(data.result=='success'){
//									alert(data.smsContent);
									yzm.value = data.yzm; //获取验证码数字
									//添加短信记录								
									mui.ajax(url+'sms/AddSms.php',{
										data:{
											flag:'add',
											SecurityCode:data.yzm,
											submodule:'在线检测',
											gcmc:gcmc,
											mytime:mytime,
											my_name:my_name,
											mobile:mobile
										},
										dataType:'json',
										type:'POST',
										timeout:10000,
										success:function(data){
//											alert(data.result);
										},
										error:function(xhr,type,errorThrown){
											alert('ajax错误'+type+'---'+errorThrown);
										}
									});
								}
							},
							error:function(xhr,type,errorThrown){
//								alert('ajax错误'+type+'---'+errorThrown);
							}
						});
		        	}
		            o.setAttribute("disabled", true);  
		            o.innerHTML="重新发送(" + wait + ")";  
		            wait--;  
		            setTimeout(function() {  
		                time(o)  
		            },1000)  
		        }  
			}
			//验证验证码
			function qdjz(jzid){
				var ulid = jzid.id;
				if(yzm.value==""){
					mui.toast('请先获取验证码',{ duration:'long', type:'div' }) 
				}else if(code.value==""){
					mui.toast('请输入验证码',{ duration:'long', type:'div' }) 
				}else if(code.value==yzm.value){
					//确定见证
					mui.openWindow({
						url:'online_change.html',
						styles: {
							hardwareAccelerated:false
						},
						extras:{
							//传递参数
							ulid:ulid,
							timestamp:timestamp,
							my_name:my_name,
							constr:constr,//施工单位
							supvision:supvision,//监理单位
							detect:detect//检测单位
						},
						show:{
							autoShow:true,//页面loaded事件发生后自动显示
							aniShow:'slide-in-right',//页面显示动画
							duration:'100'//页面动画持续时间
						},
						waiting:{
							autoShow:false,//自动显示等待框
						}
					});
				}else{
					mui.toast('验证码不正确',{ duration:'long', type:'div' }) 
				}
			}
			//复检验证码
			function recheck(jzid){
				var jzid = jzid.id;
				if(yzm.value==""){
					mui.toast('请先获取验证码',{ duration:'long', type:'div' }) 
				}else if(code_recheck.value==""){
					mui.toast('请输入验证码',{ duration:'long', type:'div' }) 
				}else if(code_recheck.value==yzm.value){
					//确定见证
					mui.ajax(url+'my_plus/my_material_list_longtap.php',{
						data:{
							gcdzt:'recheck',
							gcdId:jzid
						},
						dataType:'json',
						type:'POST', 
						timeout:10000,
						success:function(data){
							if(data.result=='success'){
   								mui.toast('见证成功',{ duration:'long', type:'div' }) 
								location.reload();
							}
						},
						error:function(xhr,type,errorThrown){
							alert('ajax错误'+type+'---'+errorThrown);
						}
					});
				}else{
					mui.toast('验证码不正确',{ duration:'long', type:'div' }) 
				}
			}

			//检测报告编号
			function inpcode(obj){
				var ulId = obj.id;
				var code_input = document.getElementById('code_input').value;
				mui.ajax(url+'detection/online_list.php',{
					data:{
						flag:"准备",
						ulid:ulId,
						gcmc:gcmc,
						timestamp:timestamp,
						code_input:code_input
					},
					dataType:'json',
					type:'POST', 
					timeout:10000,
					success:function(data){
						mui.toast(data.结果,{ duration:'long', type:'div' })
						location.reload();//刷新本页面
					},
					error:function(xhr,type,errorThrown){
											alert('ajax错误'+type+'---'+errorThrown+"失败！");
					}
				});	
			}
			//报告编号
			function inpcode1(obj){
				var ulId = obj.id;
				var testNum = document.getElementById('testNum').value;
//				alert(testNum);
				mui.ajax(url+'detection/online_list.php',{
					data:{
						flag:"合格",
						ulid:ulId,
						gcmc:gcmc,
						timestamp:timestamp,
						testNum:testNum
					},
					dataType:'json',
					type:'POST', 
					timeout:10000,
					success:function(data){
//						alert(data.结果);
						if(data.条数==0){
							var btnArray = ['是', '否'];
							mui.confirm('确定将该检测类型闭合？', '江门市气象局在线监测系统', btnArray, function(e) {
								if (e.index == 0) {
									mui.ajax(url+'detection/online_list.php',{
										data:{
											flag:"进入下一个检测",
											gcmc:gcmc,
											timestamp:timestamp
										},
										dataType:'json',
										type:'POST', 
										timeout:10000,
										success:function(data){
											var abc = [];
											abc[0] = 'detection_online';
											abc[1] = '../detection/classification.html';
//											alert(data);
											for(var i=0;i<2;i++){
												plus.webview.close(abc[i]);
											}
											
										},
										error:function(xhr,type,errorThrown){
//																alert('ajax错误'+type+'---'+errorThrown+"失败！");
										}
									});	
								}	
							});
						}else{
							mui.toast('操作成功',{ duration:'long', type:'div' }) 
							location.reload();
						}
						
					},
					error:function(xhr,type,errorThrown){
//											alert('ajax错误'+type+'---'+errorThrown+"失败！");
					}
				});	
			}
			
			//复检检测报告编号
			function recheckNum(obj){
				var ulId = obj.id;
				var recheckNum = document.getElementById('recheckNum').value;
//				alert(code);
				mui.ajax(url+'my_plus/my_material_list.php',{
					data:{
						flag:"复检合格",
						ulid:ulId,
						gcmc:gcmc,
						timestamp:timestamp,
						recheckNum:recheckNum
					},
					dataType:'json',
					type:'POST', 
					timeout:10000,
					success:function(data){
						mui.toast(data.结果,{ duration:'long', type:'div' })
						location.reload();//刷新本页面
					},
					error:function(xhr,type,errorThrown){
//											alert('ajax错误'+type+'---'+errorThrown+"失败！");
					}
				});	
			}
		</script>
	</body>

</html>